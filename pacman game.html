<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!doctype html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;meta charset="utf-8" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;title&gt;Valentine Pac-Chase ğŸ’˜&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>:root { --bg:#0b1020; --panel:#111a33; --text:#e9ecff; --muted:#9aa4d6; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>body{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>background: radial-gradient(1200px 600px at 50% 0%, #182457 0%, var(--bg) 60%, #070a14 100%);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>color:var(--text); display:flex; min-height:100vh; align-items:center; justify-content:center;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.wrap{ width:min(920px, 96vw); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>header{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:10px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(17,26,51,.55); border:1px solid rgba(255,255,255,.08);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>padding:12px 14px; border-radius:16px; backdrop-filter: blur(6px);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>header .left{ display:flex; flex-direction:column; gap:4px; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>header h1{ font-size:16px; margin:0; font-weight:700; letter-spacing:.2px; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>header .sub{ font-size:12px; color:var(--muted); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>header .right{ display:flex; gap:10px; align-items:center; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.pill{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.10);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>padding:8px 10px; border-radius:999px; font-size:12px; color:var(--text);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>display:flex; gap:10px; align-items:center;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.btn{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>cursor:pointer; user-select:none;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>border:1px solid rgba(255,255,255,.14);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>color:var(--text); padding:8px 12px; border-radius:12px; font-weight:700; font-size:12px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.btn:active{ transform: translateY(1px); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>canvas{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>width:100%; height:auto; border-radius:18px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(17,26,51,.55); border:1px solid rgba(255,255,255,.08);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>box-shadow: 0 18px 55px rgba(0,0,0,.45);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.legend{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>color:var(--muted); font-size:12px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.legend kbd{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>padding:2px 6px; border-radius:8px; color:var(--text); font-weight:700;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>/* Popup overlay */</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.overlay{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>position:fixed; inset:0; display:none; align-items:center; justify-content:center;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(0,0,0,.55); padding:18px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.card{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>width:min(560px, 96vw);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>background: rgba(17,26,51,.92);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>border:1px solid rgba(255,255,255,.12);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>border-radius:18px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>box-shadow: 0 30px 90px rgba(0,0,0,.6);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>padding:18px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.card h2{ margin:0 0 6px; font-size:16px; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.card p{ margin:0 0 14px; color:var(--text); line-height:1.35; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.card .small{ color:var(--muted); font-size:12px; margin-bottom:12px; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>.row{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;div class="wrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;header&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;div class="left"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;h1&gt;Valentine Pac-Chase ğŸ’˜&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div class="sub"&gt;Eat all dots. Donâ€™t get caught. (But if you doâ€¦ ğŸ˜‰)&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;div class="right"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div class="pill"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>&lt;span&gt;Score: &lt;b id="score"&gt;0&lt;/b&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>&lt;span&gt;Dots: &lt;b id="dots"&gt;0&lt;/b&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button class="btn" id="restart"&gt;Restart&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/header&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;canvas id="game" width="840" height="520"&gt;&lt;/canvas&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;div class="legend"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;div&gt;Controls: &lt;kbd&gt;W&lt;/kbd&gt;&lt;kbd&gt;A&lt;/kbd&gt;&lt;kbd&gt;S&lt;/kbd&gt;&lt;kbd&gt;D&lt;/kbd&gt; or Arrow keys&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;div&gt;Tip: open on phone and use swipe/arrow keys on keyboard if available.&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;div class="overlay" id="overlay"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;div class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;h2 id="popupTitle"&gt;Caught! ğŸ’¥&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;div class="small" id="popupSmall"&gt;Valentine week message unlocked&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;p id="popupText"&gt;&lt;/p&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;div class="row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button class="btn" id="tryAgain"&gt;Try again&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button class="btn" id="closePopup"&gt;Close&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;script&gt;</p>
<p class="p1">(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// --- CONFIG ---</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const TILE = 28;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const ROWS = 17;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const COLS = 27;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// 0 empty, 1 wall, 2 dot, 3 big dot (bonus)</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const MAP_STR = [</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"111111111111111111111111111",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"120000200000000000000200021",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"101111011111011111011111101",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"103000000200000000200000301",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"101111011011111111011011101",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"120000011000020000011000021",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"111110011111011111011001111",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"100010000000000000000010001",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"101011111011111111011110101",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"102000200000200200000200201",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"101111011111011111011111101",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"120000000200000000200000021",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"101111011011111111011011101",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"103000011000020000011000301",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"101111011111011111011111101",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"120000200000000000000200021",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>"111111111111111111111111111",</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const VALENTINE_WEEK = [</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>{ day: "Rose Day ğŸŒ¹", msg: "Rose Day unlocked: You got caughtâ€¦ so hereâ€™s a virtual rose ğŸŒ¹. Now run!" },</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>{ day: "Propose Day ğŸ’", msg: "Propose Day: I proposeâ€¦ you stop getting caught ğŸ˜ŒğŸ’" },</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>{ day: "Chocolate Day ğŸ«", msg: "Chocolate Day: Fine, you got caught. Pay the penalty in chocolates ğŸ«ğŸ˜‚" },</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>{ day: "Teddy Day ğŸ§¸", msg: "Teddy Day: If you get caught again, Iâ€™m sending a teddy to guard you ğŸ§¸ğŸ›¡ï¸" },</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>{ day: "Promise Day ğŸ¤", msg: "Promise Day: Promise me youâ€™ll dodge better next round ğŸ¤ğŸ˜„" },</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>{ day: "Hug Day ğŸ¤—", msg: "Hug Day: Caught = automatic hug coupon ğŸ¤— (redeemable immediately)" },</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>{ day: "Kiss Day ğŸ˜š", msg: "Kiss Day: Caught again? Okay okayâ€¦ one *tiny* victory kiss for the ghost ğŸ˜šğŸ‘»" },</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>{ day: "Valentineâ€™s Day ğŸ’˜", msg: "Valentineâ€™s Day: Youâ€™re officially my favorite playerâ€¦ even when you lose ğŸ’˜ğŸ˜Œ" },</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// --- CANVAS SETUP ---</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const canvas = document.getElementById("game");</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const ctx = canvas.getContext("2d");</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const scoreEl = document.getElementById("score");</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const dotsEl = document.getElementById("dots");</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// --- GAME STATE ---</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>let map, dotsLeft, score, running;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>let player, ghost;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>let dir = {x:0,y:0};</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>let lastMove = {x:0,y:0};</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>let tPrev = 0;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const overlay = document.getElementById("overlay");</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const popupText = document.getElementById("popupText");</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const popupTitle = document.getElementById("popupTitle");</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const popupSmall = document.getElementById("popupSmall");</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const rand = (n) =&gt; Math.floor(Math.random()*n);</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>const clamp = (v, a, b) =&gt; Math.max(a, Math.min(b, v));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function parseMap() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>map = MAP_STR.map(row =&gt; row.split("").map(ch =&gt; Number(ch)));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>dotsLeft = 0;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>for (let r=0;r&lt;ROWS;r++){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>for (let c=0;c&lt;COLS;c++){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>if (map[r][c] === 2 || map[r][c] === 3) dotsLeft++;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>dotsEl.textContent = dotsLeft;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function reset() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>parseMap();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>score = 0;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>scoreEl.textContent = score;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>running = true;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>overlay.style.display = "none";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>player = {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>r: 9, c: 13,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>x: 13*TILE + TILE/2,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>y: 9*TILE + TILE/2,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>speed: 150, // px/sec</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>radius: 10</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ghost = {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>r: 7, c: 13,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>x: 13*TILE + TILE/2,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>y: 7*TILE + TILE/2,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>speed: 130,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>radius: 10,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>mode: "chase",</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>scaredUntil: 0</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>dir = {x:0,y:0};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>lastMove = {x:0,y:0};</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function tileAt(x,y){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const c = Math.floor(x / TILE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const r = Math.floor(y / TILE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (r&lt;0||r&gt;=ROWS||c&lt;0||c&gt;=COLS) return 1;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>return map[r][c];</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function setTile(x,y,val){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const c = Math.floor(x / TILE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const r = Math.floor(y / TILE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (r&lt;0||r&gt;=ROWS||c&lt;0||c&gt;=COLS) return;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>map[r][c] = val;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function canMoveTo(nx, ny, radius){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// Check 4 corners for wall</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const corners = [</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>[nx - radius, ny - radius],</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>[nx + radius, ny - radius],</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>[nx - radius, ny + radius],</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>[nx + radius, ny + radius],</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>for (const [cx, cy] of corners){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>if (tileAt(cx, cy) === 1) return false;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>return true;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function dist(ax,ay,bx,by){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const dx=ax-bx, dy=ay-by;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>return Math.hypot(dx,dy);</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function eatDot(){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const t = tileAt(player.x, player.y);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (t === 2){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>setTile(player.x, player.y, 0);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>score += 10;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>dotsLeft--;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>} else if (t === 3){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>setTile(player.x, player.y, 0);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>score += 50;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>dotsLeft--;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>ghost.scaredUntil = performance.now() + 6000;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>scoreEl.textContent = score;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>dotsEl.textContent = dotsLeft;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (dotsLeft &lt;= 0){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>showPopup("You won! ğŸ†ğŸ’˜", "All dots cleared. Okayâ€¦ now send this link and demand a rematch ğŸ˜„");</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>running = false;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function showPopup(title, text){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>popupTitle.textContent = title;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>popupText.textContent = text;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>popupSmall.textContent = "Valentine week message unlocked";</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>overlay.style.display = "flex";</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function showCaughtMessage(){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const pick = VALENTINE_WEEK[rand(VALENTINE_WEEK.length)];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>showPopup(`Caught! ${pick.day}`, pick.msg);</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function nudgeToGrid(entity){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// snap to center of nearest tile to reduce wall-sticking</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const c = Math.round((entity.x - TILE/2) / TILE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const r = Math.round((entity.y - TILE/2) / TILE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>entity.x = c*TILE + TILE/2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>entity.y = r*TILE + TILE/2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>entity.c = c; entity.r = r;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function updatePlayer(dt){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const speed = player.speed * dt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>let nx = player.x + dir.x * speed;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>let ny = player.y + dir.y * speed;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// If blocked, try sliding along axis</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (!canMoveTo(nx, ny, player.radius)){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>// try x only</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>if (canMoveTo(nx, player.y, player.radius)){ ny = player.y; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>// try y only</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>else if (canMoveTo(player.x, ny, player.radius)){ nx = player.x; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>else { nx = player.x; ny = player.y; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>player.x = nx; player.y = ny;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>eatDot();</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function ghostAI(dt){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const now = performance.now();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const scared = now &lt; ghost.scaredUntil;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// target: chase player, or run away if scared</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>let tx = player.x, ty = player.y;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (scared){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>tx = (COLS*TILE - player.x);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>ty = (ROWS*TILE - player.y);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// Choose direction at intersections by looking 4 options</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const options = [</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>{x: 1, y: 0},</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>{x:-1, y: 0},</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>{x: 0, y: 1},</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>{x: 0, y:-1},</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// Small helper: is near tile center?</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const cx = Math.round((ghost.x - TILE/2)/TILE)*TILE + TILE/2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const cy = Math.round((ghost.y - TILE/2)/TILE)*TILE + TILE/2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const nearCenter = (Math.abs(ghost.x - cx) &lt; 2 &amp;&amp; Math.abs(ghost.y - cy) &lt; 2);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (nearCenter) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>nudgeToGrid(ghost);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>let best = null;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>for (const o of options){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>// don't reverse unless needed</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>if (o.x === -ghost.vx &amp;&amp; o.y === -ghost.vy) continue;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const nx = ghost.x + o.x * TILE * 0.9;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const ny = ghost.y + o.y * TILE * 0.9;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>if (!canMoveTo(nx, ny, ghost.radius)) continue;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const d = dist(nx, ny, tx, ty);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>if (!best || d &lt; best.d) best = {d, o};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>// if stuck, allow reverse</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>if (!best){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>for (const o of options){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>const nx = ghost.x + o.x * TILE * 0.9;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>const ny = ghost.y + o.y * TILE * 0.9;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>if (!canMoveTo(nx, ny, ghost.radius)) continue;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>const d = dist(nx, ny, tx, ty);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>if (!best || d &lt; best.d) best = {d, o};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>if (best){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>ghost.vx = best.o.x;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>ghost.vy = best.o.y;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>ghost.vx = 0; ghost.vy = 0;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const speed = (scared ? ghost.speed*0.75 : ghost.speed) * dt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>let nx = ghost.x + ghost.vx * speed;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>let ny = ghost.y + ghost.vy * speed;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (!canMoveTo(nx, ny, ghost.radius)){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>// bounce / re-evaluate next frame</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>ghost.vx = 0; ghost.vy = 0;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>nx = ghost.x; ny = ghost.y;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ghost.x = nx; ghost.y = ny;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// collision</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (dist(player.x, player.y, ghost.x, ghost.y) &lt; (player.radius + ghost.radius + 2)){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>if (scared){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>// ghost "eaten": reset ghost to spawn and score</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>score += 200;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>scoreEl.textContent = score;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>ghost.scaredUntil = 0;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>ghost.x = 13*TILE + TILE/2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>ghost.y = 7*TILE + TILE/2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>ghost.vx = 0; ghost.vy = 0;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>running = false;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>showCaughtMessage();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function draw(){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.clearRect(0,0,canvas.width,canvas.height);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// grid offset (center map inside canvas)</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const mapW = COLS*TILE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const mapH = ROWS*TILE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const ox = (canvas.width - mapW)/2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const oy = (canvas.height - mapH)/2;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.save();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.translate(ox, oy);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// walls</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>for (let r=0;r&lt;ROWS;r++){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>for (let c=0;c&lt;COLS;c++){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const t = map[r][c];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const x = c*TILE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const y = r*TILE;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>if (t === 1){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.fillStyle = "rgba(110,140,255,.22)";</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.fillRect(x, y, TILE, TILE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.strokeStyle = "rgba(255,255,255,.08)";</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.strokeRect(x+0.5, y+0.5, TILE-1, TILE-1);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>} else if (t === 2){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.fillStyle = "rgba(255,255,255,.75)";</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.arc(x+TILE/2, y+TILE/2, 3, 0, Math.PI*2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.fill();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>} else if (t === 3){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.fillStyle = "rgba(255,215,215,.9)";</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.arc(x+TILE/2, y+TILE/2, 6, 0, Math.PI*2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  </span>ctx.fill();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// player</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.fillStyle = "rgba(255, 215, 0, .95)";</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.fill();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// ghost</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const scared = performance.now() &lt; ghost.scaredUntil;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.fillStyle = scared ? "rgba(180, 210, 255, .95)" : "rgba(255, 100, 160, .95)";</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.beginPath();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.arc(ghost.x, ghost.y, ghost.radius, 0, Math.PI*2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.fill();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>ctx.restore();</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function loop(ts){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const dt = Math.min(0.033, (ts - tPrev)/1000 || 0);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>tPrev = ts;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (running){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>updatePlayer(dt);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>ghostAI(dt);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>draw();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>requestAnimationFrame(loop);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>draw();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  </span>requestAnimationFrame(loop);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// --- INPUT ---</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function setDirFromKey(k){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>const key = k.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (key === "arrowup" || key === "w") dir = {x:0,y:-1};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (key === "arrowdown" || key === "s") dir = {x:0,y:1};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (key === "arrowleft" || key === "a") dir = {x:-1,y:0};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>if (key === "arrowright" || key === "d") dir = {x:1,y:0};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>lastMove = {...dir};</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>window.addEventListener("keydown", (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>setDirFromKey(e.key);</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// Keep positions consistent if canvas size changes in CSS; we render in native size.</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>function fitCanvas(){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>// Keep native resolution stable; only CSS scales it.</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// --- UI BUTTONS ---</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>document.getElementById("restart").addEventListener("click", () =&gt; reset());</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>document.getElementById("tryAgain").addEventListener("click", () =&gt; { reset(); running = true; overlay.style.display="none"; });</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>document.getElementById("closePopup").addEventListener("click", () =&gt; { overlay.style.display="none"; });</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// --- START ---</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>reset();</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// initial ghost movement direction</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>ghost.vx = 0; ghost.vy = 1;</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>requestAnimationFrame(loop);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// Translate drawing coordinates to centered map by shifting entity coords too</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>// We already store entity coords in map-space; nothing else needed.</p>
<p class="p1">})();</p>
<p class="p1">&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
